@using Core.Utilities.Results
@using Entity.Concrete
@using Entity.DTOs
@{
    ViewData["Title"] = "Sınav Detay";
    var dbap = ViewData["DBAP"] as IDataResult<List<DersBolumAkademikPersonel>>;
    var dbap_detail = ViewData["DBAPDetail"] as IDataResult<List<DersBolumAkademikPersonelDTO>>;
    var sinavs = ViewData["SinavDetay"] as IDataResult<List<SinavDetayDTO>>;
    var derslikler = ViewData["Derslikler"] as IDataResult<List<Derslik>>;

}

@section Styles {
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
}

<style>
    .calendar-container {
        height: calc(100vh - 100px);
        overflow: hidden;
    }

    .sticky-sidebar {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
    }

    .fc {
        height: 100% !important;
        background-color: #fff;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
    }

    .fc-timegrid-slot {
        height: 50px !important;
    }

    .fc-timegrid-slot-lane {
        border-bottom: 1px solid #ddd !important;
    }

    .fc-timegrid-slots td {
        height: 50px !important;
        border-bottom: 1px solid #ddd !important;
    }

    .fc-col-header-cell {
        background-color: #f8f9fa;
        padding: 8px !important;
    }

    .fc-timegrid-axis {
        padding: 10px !important;
    }

    .fc-button-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .fc-event {
        margin: 2px;
        padding: 3px;
    }

    .fc-toolbar-chunk {
        display: flex;
        gap: 5px;
    }

    .fc .fc-toolbar {
        padding: 10px;
    }

    .fc .fc-toolbar-title {
        font-size: 1.25rem;
        margin: 0;
    }

    .external-event {
        box-shadow: 0 0 1px rgba(0, 0, 0, 0.125), 0 1px 3px rgba(0, 0, 0, 0.2);
        border-radius: 3px;
        cursor: move;
        font-weight: bold;
        margin-bottom: 10px;
        padding: 10px;
        color: #fff;
    }
    
    /* Ders renkleri */
    .bolum-color-1 { background-color: #2196F3; }  /* Bilgisayar - Mavi */
    .bolum-color-2 { background-color: #F44336; }  /* İnşaat - Kırmızı */
    .bolum-color-3 { background-color: #4CAF50; }  /* Elektronik - Yeşil */
    .bolum-color-4 { background-color: #9C27B0; }  /* Alternatif - Mor */
    .bolum-color-5 { background-color: #FF9800; }  /* Diğer - Turuncu */

    .bolum-baslik {
        font-size: 1rem;
        font-weight: 600;
        padding: 10px;
        margin: 15px 0 10px 0;
        border-left: 4px solid #2c3e50;
        background-color: #f8f9fa;
        border-radius: 0 4px 4px 0;
    }

    .bolum-grup {
        margin-bottom: 20px;
    }

    .bolum-grup:first-child .bolum-baslik {
        margin-top: 0;
    }
</style>

<div class="container-fluid mt-4">
    @Html.AntiForgeryToken()
    <div class="row">
        <div class="col-md-3">
            <div class="sticky-sidebar">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Sürüklenebilir Dersler</h3>
                    </div>
                    <div class="card-body">
                        <!-- Sol taraftaki derslik seçimi -->
                        <div class="form-group mb-3">
                            <label>Derslik Seçimi</label>
                            <select id="mainDerslikFilter" class="form-control js-example-basic-multiple">
                                @foreach (var derslik in derslikler.Data)
                                {
                                    <option value="@derslik.Id">@derslik.Ad (@derslik.Kapasite)</option>
                                }
                            </select>
                        </div>
                        
                        <!-- Sürüklenebilir Etkinlikler -->
                        <div id="external-events">
                            @{
                                var bolumRenkMap = new Dictionary<int, string>();
                                var renkIndex = 1;
                                var gruplanmisDersler = dbap_detail.Data
                                    .GroupBy(x => x.BolumId)
                                    .Select(g => new
                                    {
                                        BolumId = g.Key,
                                        BolumAd = g.First().BolumAd,
                                        Dersler = g.GroupBy(d => d.DersId)
                                                  .Select(d => d.First())
                                                  .OrderBy(d => d.DersAd)
                                    })
                                    .OrderBy(x => x.BolumAd);
                            }
                            
                            @foreach (var bolum in gruplanmisDersler)
                            {
                                if (!bolumRenkMap.ContainsKey(bolum.BolumId))
                                {
                                    bolumRenkMap[bolum.BolumId] = $"bolum-color-{(renkIndex++ % 5) + 1}";
                                }
                                
                                <div class="bolum-grup">
                                    <div class="bolum-baslik">
                                        <i class="bi bi-building me-2"></i>@bolum.BolumAd
                                    </div>
                                    @foreach (var ders in bolum.Dersler)
                                    {
                                        <div class="external-event @bolumRenkMap[bolum.BolumId]" 
                                             data-id="@ders.Id" 
                                             data-ders-id="@ders.DersId"
                                             data-bolum-id="@ders.BolumId"
                                             data-color="@bolumRenkMap[bolum.BolumId]">
                                            <h5>@ders.DersAd</h5>
                                            <p>@ders.AkademikPersonelAd</p>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card card-primary calendar-container">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <!-- Buradan derslik filtresini kaldırıyoruz -->
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- jQuery UI -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <!-- Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/tr.js'></script>

    <!-- Takvim için gerekli verileri global değişkenlere aktar -->
    <script>
        const INITIAL_DATA = {
            derslikler: @Html.Raw(Json.Serialize(derslikler.Data)),
            dbapDetail: @Html.Raw(Json.Serialize(dbap_detail.Data)),
            sinavlar: @Html.Raw(Json.Serialize(sinavs.Data)),
            akademikPersoneller: @Html.Raw(Json.Serialize(ViewData["AkademikPersoneller"]))
        };
    </script>

    <!-- Takvim yönetimi için özel JavaScript -->
    <script src="~/js/sinavTakvimi.js"></script>
}
