@using Core.Utilities.Results
@using Entity.Concrete
@using Entity.DTOs
@{
    ViewData["Title"] = "Bölüm-Ders-Akademik Personel Yönetimi";
    var bolumler = ViewData["Bolumler"] as IDataResult<List<Bolum>>;
    var dersler = ViewData["Dersler"] as IDataResult<List<Ders>>;
    var akademikPersoneller = ViewData["APler"] as IDataResult<List<AkademikPersonel>>;
    var bolumDersAkademikPersonelEslestirmeleri = ViewData["BDAP"] as IDataResult<List<DersBolumAkademikPersonelDTO>>;
}

<style>
    .selected-row {
        background-color: #007bff; /* Mavi */
        color: white; /* Yazı rengini beyaz yapar */
    }

    .table-container {
        height: 200px;
        overflow-y: auto;
        margin-bottom: 20px;
    }

    .table-container table {
        margin-bottom: 0;
    }

    .table-container thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 1;
    }

    .right-table {
        height: calc(100vh - 120px);
        margin-bottom: 20px;
    }

    .right-table .table-responsive {
        height: calc(100vh - 170px);
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }

    .right-table table {
        margin-bottom: 0;
        width: 100%;
    }

    .right-table thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 1;
        border-bottom: 2px solid #dee2e6;
    }

    /* Yatay scroll için */
    .right-table .table-responsive {
        overflow-x: auto;
    }

    .right-table tbody {
        background-color: white;
    }

    /* Tüm tablolar için ortak özellikler */
    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 500;
    }

    .table tbody tr:hover {
        background-color: rgba(0,123,255,0.05);
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Bölüm-Ders-Akademik Personel Listesi</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#bdapModal">
                            Yeni Eşleştirme Ekle
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table id="bdapTable" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Bölüm</th>
                                <th>Ders</th>
                                <th>Akademik Personel</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in ViewData["BDAP"] as IEnumerable<Entity.DTOs.DersBolumAkademikPersonelDTO>)
                            {
                                <tr>
                                    <td>@item.Id</td>
                                    <td>@item.BolumAd</td>
                                    <td>@item.DersAd</td>
                                    <td>@item.AkademikPersonelAd (@item.Unvan)</td>
                                    <td>
                                        <button class="btn btn-sm btn-info edit-bdap" data-id="@item.Id">Düzenle</button>
                                        <button class="btn btn-sm btn-danger delete-bdap" data-id="@item.Id">Sil</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- BDAP Modal -->
<div class="modal fade" id="bdapModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bölüm-Ders-Akademik Personel Eşleştirme</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="bdapForm">
                    <input type="hidden" id="bdapId" />
                    <div class="form-group">
                        <label for="bolumId">Bölüm</label>
                        <select class="form-control" id="bolumId" required>
                            <option value="">Bölüm Seçiniz</option>
                            @foreach (var bolum in ViewData["Bolumler"] as IEnumerable<Entity.Concrete.Bolum>)
                            {
                                <option value="@bolum.Id">@bolum.Ad</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dersId">Ders</label>
                        <select class="form-control" id="dersId" required>
                            <option value="">Ders Seçiniz</option>
                            @foreach (var ders in ViewData["Dersler"] as IEnumerable<Entity.Concrete.Ders>)
                            {
                                <option value="@ders.Id">@ders.Ad</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="akademikPersonelId">Akademik Personel</label>
                        <select class="form-control" id="akademikPersonelId" required>
                            <option value="">Akademik Personel Seçiniz</option>
                            @foreach (var personel in ViewData["APler"] as IEnumerable<Entity.Concrete.AkademikPersonel>)
                            {
                                <option value="@personel.Id">@personel.Ad (@personel.Unvan)</option>
                            }
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="saveBdap">Kaydet</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // DataTable initialization
            $('#bdapTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Turkish.json"
                }
            });

            // Yeni BDAP ekleme
            $('#saveBdap').click(function () {
                var bdap = {
                    Id: $('#bdapId').val(),
                    BolumId: $('#bolumId').val(),
                    DersId: $('#dersId').val(),
                    AkademikPersonelId: $('#akademikPersonelId').val()
                };

                var url = bdap.Id ? '/BolumDersAkademikPersonel/Update' : '/BolumDersAkademikPersonel/Add';
                var method = bdap.Id ? 'PUT' : 'POST';

                $.ajax({
                    url: url,
                    type: method,
                    contentType: 'application/json',
                    data: JSON.stringify(bdap),
                    success: function (response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Hata: ' + response.message);
                        }
                    },
                    error: function (xhr) {
                        alert('Bir hata oluştu: ' + xhr.responseText);
                    }
                });
            });

            // BDAP düzenleme
            $('.edit-bdap').click(function () {
                var id = $(this).data('id');
                $.get('/BolumDersAkademikPersonel/GetDetail/' + id, function (bdap) {
                    $('#bdapId').val(bdap.id);
                    $('#bolumId').val(bdap.bolumId);
                    $('#dersId').val(bdap.dersId);
                    $('#akademikPersonelId').val(bdap.akademikPersonelId);
                    $('#bdapModal').modal('show');
                });
            });

            // BDAP silme
            $('.delete-bdap').click(function () {
                if (confirm('Bu eşleştirmeyi silmek istediğinizden emin misiniz?')) {
                    var id = $(this).data('id');
                    $.ajax({
                        url: '/BolumDersAkademikPersonel/Delete',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ Id: id }),
                        success: function (response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                alert('Hata: ' + response.message);
                            }
                        },
                        error: function (xhr) {
                            alert('Bir hata oluştu: ' + xhr.responseText);
                        }
                    });
                }
            });

            // Modal kapandığında formu temizle
            $('#bdapModal').on('hidden.bs.modal', function () {
                $('#bdapForm')[0].reset();
                $('#bdapId').val('');
            });
        });
    </script>
}